api_version: v1

app:
  min_ready_routes: all
  readiness_cache: 250ms

connectors:

  - name: http_ingest
    type: http
    options:
      role: server
      host: 0.0.0.0
      port: 9090
      health:
        method: GET
        path: /healthz

  - name: stream_processor_grpc
    type: grpc
    options:
      endpoint: https://processor.internal:7443
      descriptor: schemas/summary.desc
      tls:
        ca: tls/processor-ca.pem
      metadata:
        authorization: Bearer ${PROCESSOR_TOKEN}

chronicles:

  - name: http_ingest_to_grpc
    trigger:
      connector: http_ingest
      options:
        method: POST
        path: /api/v1/records
        content_type: application/json
    phases:
      - name: build_ingest_envelope
        type: transform
        options:
          envelope:
            event_id: .[0].body.record.id
            partition_key: .[0].body.record.id
            schema_key: record.v1
            observed_at: .[0].body.record.observed_at
            trace_id: .[0].headers.trace_id
          payload:
            attributes: .[0].body.record.attributes
            metrics: .[0].body.record.metrics
      - name: push_event_grpc
        type: grpc_client
        options:
          connector: stream_processor_grpc
          rpc: chronicle.ingest.v1.RecordIngress/Push
          request:
            envelope:
              eventId: .[1].envelope.event_id
              partitionKey: .[1].envelope.partition_key
              schemaKey: .[1].envelope.schema_key
              observedAt: .[1].envelope.observed_at
            payload: .[1].payload
          metadata:
            x-trace-id: .[1].envelope.trace_id
      - name: respond_to_client
        type: transform
        options:
          status: 202
          content_type: application/json
          body:
            record_id: .[1].envelope.event_id
            delivered: true
            upstream_ack: .[2].status
            trace_id: .[1].envelope.trace_id

management:
  host: 0.0.0.0
  port: 9091
  live:
    path: /live
  ready:
    path: /ready
  status:
    path: /status
  metrics:
    path: /metrics
